
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
<!-- If no var is set for $page_title on the top of each page than default title will be HDF Group -->

<title>
The HDF Group - Information, Support, and Software</title>
	<meta name="keywords" content="hdf, hdfeos, blog, hdf blog, hdf5 blog, hdf5, hdf4, hdf tools, hdf libraries, hdf viewer, hdf format, hdf file, hdf java, nafxcw.lib, phdf5, open source, hierarchical data format, ncsa, database, python hdf, mike folk, hdfview, hdf5 parallel" />
	<meta name="description" content="The HDF Group is a not-for-profit corporation with the mission of sustaining the HDF technologies and supporting HDF user communities worldwide with production-quality software and services." />
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="expires" content="Wed, 26 Feb 2010 08:21:57 GMT" />
	<meta name="verify-v1" content="/m03HNmaDgGAcDe0PFtEVnXGtCkoeOocjr/Jwey2gdI=" />
	<link href="../../css/layout.css" rel="stylesheet" type="text/css" media="screen, projection" />
	<link href="../../css/print.css" rel="stylesheet" type="text/css" media="print" />
	<link rel="stylesheet" type="text/css" href="../../css/js_style.css" />
	<link rel="shortcut icon" href="../../images/favicon.ico" type="image/x-icon" />
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/prototype/1.7.2.0/prototype.js"></script>
	<!--<script type="text/javascript" src="/scriptaculous/lib/prototype.js"></script>-->
	<script type="text/javascript" src="../../scriptaculous/src/effects.js"></script>
	<script type="text/javascript" src="../../scriptaculous/validation.js"></script>
	<script type="text/javascript" src="../../scriptaculous/animatedcollapse.js"></script>
	<script type="text/javascript" src="../../scriptaculous/rollover.js"></script>	
	<script type="text/javascript" src="../../scriptaculous/functions.js"></script>
	<script type="text/javascript" src="../../scriptaculous/sorttable.js"></script>
	<!--<script type="text/javascript" src="/jquery-1.2.2.pack.js"></script>-->
	<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
	<script type="text/javascript" src="../../scriptaculous/jssor.slider.min.js"></script>

 	<link rel="stylesheet" type="text/css" href="../../featuredcontentglider.css" />
    <script type="text/javascript" src="../../featuredcontentglider.js"></script>

	</head>
	<body>
	<div id="mast_head">
		<a href="https://www.hdfgroup.org/"><img src="../../images/hdf_logo.jpg" height="70" style="display:block; padding-left:10px;" align="left" alt="hdf images" /></a>
		<img src="../../images/logo_5.jpg" height="70" style="display:block;" align="right" alt="hdf images" />
	</div> 
				
	<div id="nav_wrapper">
		<div>
		<div id="section-">
			<ul id="nav">
				<li id="t-index"><a href="https://www.hdfgroup.org/">Home</a> </li>
				<li id="t-products"><a href="../../products/index.html">Products</a></li>
				<li id="t-services"><a href="../../services/index.html">Services</a></li>
				<li id="t-about"><a href="../../about/index.html">About Us</a></li>
				<li id="t-news"><a href="../../news/index.html">News</a> </li>
				<li id="t-blog"><a href="https://www.hdfgroup.org/blog">Blog</a></li>
				<li id="t-contact"><a href="../../about/contact.html">Contact Us</a></li> 
			</ul>
			<script type="text/javascript">
			
  (function() {
    var cx = '007250492606109219119:sb2eg2bgoyy';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>	
					<script type="text/javascript">
					    jQuery(document).ready(function ($) {
					        // var options = {
					        //     $ArrowNavigatorOptions: {
					        //         $Class: $JssorArrowNavigator$,
					        //         $ChanceToShow: 2
					        //     }
					        // };					    	


							var options = { 
											$AutoPlay: true, $SlideshowOptions: { $Class: $JssorSlideshowRunner$, $Transitions: [{ $Duration:5000, $Fade: true, $Opacity:2 }] } , 
											$ArrowNavigatorOptions: { 
												$Class: $JssorArrowNavigator$, 
												$ChanceToShow: 2
											}
										  };


					        var jssor_slider1 = new $JssorSlider$('slider1_container', options);
					    });
					</script>
									                  
			
		</div>
		</div>             
	</div>
				
<!--START: MAIN -->
<div id="wrapper" style="margin-top:-15px;"> 

<!--START: SIDE_BAR -->
<div id="side_bar">

<form method="get" action="swmr.html" class="form" >
	<select onchange="window.open(this.options[this.selectedIndex].value,'_top')" name="" style="border:2px solid #c1c1c1;">
		<option value="" class="ql1">- - Quick Links - -</option>
		<option value="/HDF5/" class="ql">HDF5</option>
		<option value="/products/hdf4/" class="ql">HDF4</option>
		<option value="/tools/" class="ql">Tools</option>
		<option value="/projects/" class="ql">Projects</option>
		<option value="/downloads/" class="ql">Downloads</option>
		<option value="/documentation/" class="ql">Documentation</option>
	        <option value="/pubs/" class="ql">Publications</option>
		<option value="/about/" class="ql">Contact Us</option>
	</select>
</form>
<ul style="border:1px solid #c1c1c1; margin-top:25px;"> 

	<li style="background:url(../../images/menubg.png); padding:0px; padding-left:7px; color:#27343C; font-weight:500; text-align:left;">
	LINKS</li><li><a href="https://www.hdfgroup.org/">Main Website</a></li><li><a  href="../whatishdf5.html">What is HDF5?</a></li><li><a  href="../../about/HDF5Brochure_2012.pdf">Online Brochure</a></li><li><a  href="../../downloads/index.html">Downloads</a></li><li><a  href="../doc/index.html">Documentation</a></li><li><a  href="../../products/hdf5_tools/index.html">Software using HDF5</a></li><li><a  href="../users5.html">HDF5 Users</a></li><li><a  href="../hdf5-files.html">Sample HDF5 Files</a></li><li><a  href="../acknowledge5.html">Acknowledgments</a></li><li><a  href="../../products/licenses.html">Licenses</a></li></ul> 

</div>

<!--END: SIDE_BAR -->

<!--START: CONTENT -->
<div id="content">
<p><font color="red"><center><strong>This web site is no longer maintained (but will remain online).<br /> Please see The HDF Group's new <a href="https://portal.hdfgroup.org">Support Portal</a> for the latest information.</strong></center></font></p>
	<div class=bc><p style="color:orange; ";><a href="../../index.html" title="HOME">HOME</a> &gt; <a href="../../products/hdf5/index.html" title="HDF5">HDF5</a> &gt; <a href="../Tutor.html" title="TUTOR">TUTOR</a></p></div>
<fieldset><h1>HDF5 Tutorial: &nbsp; Single-Writer / Multiple-Reader (SWMR)</h1></fieldset>

<h2>Contents:</h2>

<ul class="ul">
<li class="li3"><a href="swmr.html#desc">Introduction to SWMR</a></li>
<li class="li3"><a href="swmr.html#doc">Documentation</a></li>

<li class="li3"><a href="swmr.html#pm">Programming Model</a></li>
<!--
<li class="li3"><a href="#funcvds">Functions for Working with SWMR</a></li>
-->
<li class="li3"><a href="swmr.html#lim">Limitations and Scope</a></li>
<li class="li3"><a href="swmr.html#tools">Tools for Working with SWMR</a></li>
<li class="li3"><a href="swmr.html#pex">Programming Example</a></li>
</ul>

<hr />

<a name="desc"></a>
<h2>Introduction to SWMR</h2>
<p>
The Single-Writer / Multiple-Reader (SWMR) feature enables multiple processes to
read an HDF5 file while it is being written to (by a single process) without
using locks or requiring communication between processes. 
</p>
<p>
<img src="../../images/tutr-swmr1.png" width=500></img>
</p>
<p>
All communication between processes must be performed via the HDF5 file. The HDF5 file under
SWMR access must reside on a system that complies with POSIX write() semantics.
</p>
The basic engineering challenge for this to work was to ensure that the readers of an 
HDF5 file always see a coherent (though possibly not up to date) HDF5 file.  
<p>
The issue is that when writing data there is information in the metadata cache in addition to the physical
file on disk:
<img src="../../images/tutr-swmr2.png" width=500></img>

<p>
However, the readers can only see the state contained in the physical file:
<p>
<img src="../../images/tutr-swmr3.png" width=500></img>
</p>

<p>
The SWMR solution implements dependencies on when the metadata can be flushed to the
file. This ensures that metadata cache flush operations occur in the proper order, so that there will
never be internal file pointers in the physical file that point to invalid (unflushed)
file addresses. 

<!--
<img src="/images/tutrswmr7.png" width=500></img>
<img src="/images/tutrswmr8.png" width=500></img>
<img src="/images/tutrswmr9.png" width=500></img>
-->

<p>
A beneficial side effect of using SWMR access is better fault tolerance. It is more difficult to corrupt a file
when using SWMR.
</p>
<a name="doc"></a>
<h2>Documentation</h2>

<p>
The <a href="../docNewFeatures/NewFeaturesSwmrDocs.html">Single-Writer/Multiple Reader (SWMR) Documentation</a>
has complete details about SWMR. Numerous API changes have been made in support of SWMR. New SWMR APIs that are mentioned in
this tutorial are listed below:
<ul class="ul">
<li class="li3"><a href="../doc/RM/RM_H5F.html#File-StartSwmrWrite">H5Fstart_swmr_write</a>: Starts SWMR access to the file</li>
<li class="li3">H5Dflush: Flushes all buffers associated with a dataset</li>
<li class="li3">H5Drefresh: Clears the buffers and reloads from disk</li>
</ul>
</p>
<p>
See the documentation for more information regarding these and other SWMR APIs.
</p>

<a name="pm"></a>
<h2>Programming Model</h2>

<p>
Please be aware that the SWMR feature requires that an HDF5 file be created with the latest file format.
See <a href="../doc/RM/RM_H5P.html#Property-SetLibverBounds">H5Pset_libverbounds</a> 
for more information.
</p>

<p>
To use SWMR follow the the general programming model for creating and accessing HDF5 files and objects
along with the steps described below.
</p>

<h3>SWMR Writer:</h3>
<p>
The SWMR writer either opens an existing file and objects or creates them as follows.
</p>
<p>
Open an existing file: 
<ul class="ul">
<li class="li3">Call H5Fopen using the H5F_ACC_SWMR_WRITE flag.</li>
<li class="li3">Begin writing datasets.</li>
<li class="li3">Periodically flush data.</li>
</ul>
</p>
<p>
Create a new file:
<ul class="ul">
<li class="li3">Call H5Fcreate using the latest file format.</li>
<li class="li3">Create groups, datasets and attributes, and then close the attributes.</li>
<li class="li3">Call <a href="../doc/RM/RM_H5F.html#File-StartSwmrWrite">H5Fstart_swmr_write</a> 
 to start SWMR access to the file.</li>
<li class="li3">Periodically flush data.</li>
</ul>
</p>

<p><strong>Example Code:</strong></p>

<p>
Create the file using the latest file format property:
</p>

<ul class="ul">
<table>
<tr>
<td>
<pre>
   fapl = H5Pcreate (H5P_FILE_ACCESS); 
   status = H5Pset_libver_bounds (fapl, H5F_LIBVER_LATEST, H5F_LIBVER_LATEST); 
   fid = H5Fcreate (filename, H5F_ACC_TRUNC, H5P_DEFAULT, fapl); 
</pre>
</td>
</tr>
</table>
</ul>

<p>
   [Create objects (files, datasets, ...). Close any attributes and named datatype objects. Groups
   and datasets may remain open before starting SWMR access to them.]
</p>
<p>
Start SWMR access to the file:</p>
<ul class="ul">
<table>
<tr>
<td>
<pre>
   status = H5Fstart_swmr_write (fid);  
</pre>
</td>
</tr>
</table>
</ul>

<p> Reopen the datasets and start writing, periodically flushing data:</p>

<ul class="ul">
<table>
<tr>
<td>
<pre>
   status = H5Dwrite (dset_id, ...);
   status = H5Dflush (dset_id); 
</pre>
</td>
</tr>
</table>
</ul>

<h3>SWMR Reader:</h3>

<p>The SWMR reader must continually poll for new data:</p>
<p>
<ul class="ul">
<li class="li3">Call H5Fopen using the H5F_ACC_SWMR_READ flag.</li>
<li class="li3">Poll, checking the size of the dataset to see if there is new data available for reading.
</li>
<li class="li3">Read new data, if any.</li>
</ul>
</p>

<p><strong>Example Code:</strong></p>
<p>
Open the file using the SWMR read flag:
</p>

<ul class="ul">
<table>
<tr>
<td>
<pre>
   fid = H5Fopen (filename, H5F_ACC_RDONLY | H5F_ACC_SWMR_READ, H5P_DEFAULT);
</pre>
</td>
</tr>
</table>
</ul>

<p>
Open the dataset and then repeatedly poll the dataset, by getting the dimensions, reading new data, and refreshing:
</p>

<ul class="ul">
<table>
<tr>
<td>
<pre>
   dset_id = H5Dopen (...);
   space_id = H5Dget_space (...);
   while (...) { 
      status = H5Dread (dset_id, ...);
      status = H5Drefresh (dset_id);
      space_id = H5Dget_space (...);
   }
</pre>
</td>
</tr>
</table>
</ul>



<a name="lim"></a>
<h2>Limitations and Scope</h2>
<p>
An HDF5 file under SWMR access must reside on a system that complies with POSIX write() semantics.
It is also limited in scope as follows:
</p>
<p>
The writer process is only allowed to modify raw data of existing datasets by;
<ul class="ul">
<li class="li3">Appending data along any unlimited dimension.</li>
<li class="li3">Modifying existing data</li>
</ul>
</p>
<p>
The following operations are not allowed (and the corresponding HDF5 files will fail):
<ul class="ul">
<li class="li3">The writer cannot add new objects to the file.</li>
<li class="li3">The writer cannot delete objects in the file.</li>
<li class="li3">The writer cannot modify or append data with variable length,
   string or region reference datatypes.</li>
<li class="li3">File space recycling is not allowed. As a result the size of a file
   modified by a SWMR writer may be larger than a file modified by a non-SWMR writer.</li>
</ul>

<a name="tools"></a>
<h2>Tools for Working with SWMR</h2>
<p>
Two new tools, <span style="font-family:calibri">h5watch</span> and <span style="font-family:calibri">h5clear</span>, are available for use with SWMR. The other HDF5 utilities have also been modified to recognize SWMR:
<ul class="ul">
 <li class="li3">The <span style="font-family:calibri">h5watch</span> tool allows a user to monitor the growth of a dataset.
 </li>
  <li class="li3">The <span style="font-family:calibri">h5clear</span> tool clears the status flags in the superblock of an HDF5 file.</li>
<!--
 <li class="li3">The <span style="font-family:calibri">h5dump</span> and <span style="font-family:calibri">h5ls</span> tools are  SWMR enabled.</li>
-->
 <li class="li3">The rest of the HDF5 tools will exit gracefully but not work with SWMR otherwise.
<!--
(, reporting that the file is
   under construction (<span style="font-family:calibri">h5diff</span>, <span style="font-family:calibri">h5repack</span>, 
<span style="font-family:calibri">h5copy</span>, <span style="font-family:calibri">h5jam</span>, ..).
-->
  </li>
</ul>
</p>

<a name="pex"></a>
<h2>Programming Example</h2>

<p>
A good example of using SWMR is included with the HDF5 tests in the source code. You can run it while reading the file it creates. 
If you then interrupt the application and reader and look at the resulting file, you will see that the file is still valid.
Follow these steps: 
</p>
<ul class="ul">
<li class="li3">
<p>
Download the <a href="https://www.hdfgroup.org/downloads/hdf5/source-code/">HDF5-1.10</a> source code to a local directory on a filesystem (that complies with POSIX write() semantics). Build the software. 
No special configuration options are needed to use SWMR.<br />
</p>
</li>
<li class="li3">
<p>
Invoke two command terminal windows. In one window go into the <span style="font-family:calibri">bin/</span> directory of the built binaries.
In the other window go into the <span style="font-family:calibri">test/</span> directory of the HDF5-1.10 source code that was just built. 
</p>
</li>
<li class="li3">
<p>
In the window in the <span style="font-family:calibri">test/</span> directory compile and run 
<span style="font-family:calibri">use_append_chunk.c</span>. The example writes a three dimensional dataset by planes (with chunks of size 1 x 256 x 256). 
</p>
</li>
<li class="li3">
<p>
In the other window (in the <span style="font-family:calibri">bin/</span> directory) run <span style="font-family:calibri">h5watch</span> 
on the file created by <span style="font-family:calibri">use_append_chunk.c</span>
(<span style="font-family:calibri">use_append_chunk.h5</span>). 
It should be run while <span style="font-family:calibri">use_append_chunk</span> is executing and you will
see valid data displayed with <span style="font-family:calibri">h5watch</span>.
</p>
</li>
<li class="li3">
<p>
Interrupt <span style="font-family:calibri">use_append_chunk</span> while it is running, and stop  <span style="font-family:calibri">h5watch</span>. 
</p>
</li>
<li class="li3">
<p>
Use <span style="font-family:calibri">h5clear</span> 
to clear the status flags in the superbock of the HDF5 file (<span style="font-family:calibri">use_append_chunk.h5</span>). 
</p>
</li>
<li class="li3">
<p>
View the file with <span style="font-family:calibri">h5dump</span>. You will see that it is a 
valid file even though the application did not close properly. It will contain data up to the point that it was interrupted.
</p>
</li>
</ul>


<hr />
<i>
- - Last modified: 02 May 2017</i>
	   </div>
	   <!--END: CONTENT -->
<!--END: WRAPPER -->
<script src="../../scriptaculous/gatag.js" type="text/javascript"></script>

<!-- <script type="text/javascript" src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script type="text/javascript" src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script> -->
				
<!--
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>

<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-3782034-1");
pageTracker._trackPageview();
} catch(err) {}</script>
-->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-3782034-1', 'auto');
  ga('send', 'pageview');

</script>

</body>
</html>
